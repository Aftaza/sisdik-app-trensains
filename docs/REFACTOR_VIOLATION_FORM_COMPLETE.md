# Violation Log Form - Complete Refactor

## Overview

Completely refactored `violation-log-form.tsx` from **435 lines** to **320 lines** with updated API structure.

## Changes Made

### 1. Form Schema - Simplified

**Before (Old):**
```typescript
const formSchema = z.object({
    jenis_pelanggaran: z.string(),
    nama_siswa: z.string(),
    tanggal_terjadi: z.date(),
    catatan: z.string(),
    guru_bk: z.string(),
    poin: z.number(),
    violationTypeId: z.string(),
});
```

**After (New):**
```typescript
const formSchema = z.object({
    student_id: z.string().uuid(),
    violation_type_id: z.string().uuid(),
    reporting_teacher_id: z.string().uuid(),
    notes: z.string().min(10),
});
```

### 2. Field Name Updates

| Old Field | New Field | Change |
|-----------|-----------|--------|
| `jenis_pelanggaran` | `violation_type_id` | String → UUID |
| `nama_siswa` | `student_id` | String → UUID |
| `tanggal_terjadi` | (removed) | Auto-generated by backend |
| `catatan` | `notes` | Renamed |
| `guru_bk` | `reporting_teacher_id` | String → UUID |
| `poin` | (removed) | Auto-calculated from violation_type |
| `violationTypeId` | `violation_type_id` | Renamed |

### 3. Student Field Updates

**Before:**
```typescript
student?.nama_lengkap  // String
student?.kelas         // String
```

**After:**
```typescript
student?.name          // String
student?.classes?.name // Nested object
```

### 4. Teacher Field Updates

**Before:**
```typescript
teacher.jabatan === 'Guru BK'  // Old field
teacher.nama                    // Old field
```

**After:**
```typescript
teacher.role === 'Guru BK'     // New field
teacher.name                    // New field
```

### 5. Violation Type Field Updates

**Before:**
```typescript
type.nama_pelanggaran  // Old field
type.poin              // Unchanged
```

**After:**
```typescript
type.name              // New field
type.poin              // Unchanged
```

### 6. API Request Body

**Before:**
```typescript
const body = {
    nis: selectedNis,
    nama_siswa: values.nama_siswa,
    pelanggaran: values.jenis_pelanggaran,
    tanggal_terjadi: formattedDate,
    catatan: values.catatan,
    guru_bk: values.guru_bk,
    poin: values.poin,
};
```

**After:**
```typescript
const body = {
    student_id: values.student_id,
    violation_type_id: values.violation_type_id,
    reporting_teacher_id: values.reporting_teacher_id,
    notes: values.notes,
};
```

### 7. Removed Complexity

**Removed:**
- ❌ Manual date formatting
- ❌ NIS lookup logic
- ❌ Manual point calculation
- ❌ Violation type name handling
- ❌ Teacher name to ID conversion

**Why:** Backend now handles these automatically

### 8. Simplified Logic

**Before (Complex):**
```typescript
// Find student by name
const selectedStudent = allStudents?.find(s => s.nama_lengkap === values.nama_siswa);
const selectedNis = selectedStudent?.nis;

// Find violation type
const selectedType = violationTypes?.find(type => type.id.toString() === value);
form.setValue('jenis_pelanggaran', selectedType.nama_pelanggaran);
form.setValue('poin', selectedType.poin);

// Format date
const formattedDate = values.tanggal_terjadi.toISOString();
```

**After (Simple):**
```typescript
// Just use IDs directly
const body = {
    student_id: values.student_id,
    violation_type_id: values.violation_type_id,
    reporting_teacher_id: values.reporting_teacher_id,
    notes: values.notes,
};
```

## Form Fields

### 1. Student Selection
```typescript
<Select value={student_id}>
    <SelectItem value={uuid}>
        {student.name} ({student.classes?.name})
    </SelectItem>
</Select>
```

### 2. Violation Type Selection
```typescript
<Select value={violation_type_id}>
    <SelectItem value={uuid}>
        {type.name} (+{type.poin} poin)
    </SelectItem>
</Select>
```

### 3. Teacher Selection
```typescript
<Select value={reporting_teacher_id}>
    <SelectItem value={uuid}>
        {teacher.name}
    </SelectItem>
</Select>
```

### 4. Notes
```typescript
<Textarea
    placeholder="Jelaskan detail kejadian pelanggaran..."
    value={notes}
/>
```

## Benefits

### 1. Simpler ✅
- 435 lines → 320 lines (26% reduction)
- Less logic, more declarative
- Easier to understand

### 2. More Reliable ✅
- UUID-based (no name matching)
- Backend handles calculations
- Less room for errors

### 3. Better Performance ✅
- Fewer lookups
- Less data transformation
- Faster form submission

### 4. Maintainable ✅
- Clear field mapping
- Standard API structure
- Easy to debug

## Migration Guide

### For Users
**No changes needed!** Form looks the same, just works better.

### For Developers

**Old way:**
```typescript
// Had to find student by name
const student = allStudents?.find(s => s.nama_lengkap === name);
```

**New way:**
```typescript
// Use ID directly
student_id: selectedId
```

## Testing Checklist

- [ ] Can select student (if not student-specific)
- [ ] Can select violation type
- [ ] Can select Guru BK
- [ ] Can enter notes (min 10 chars)
- [ ] Form validates correctly
- [ ] Can submit new violation
- [ ] Can edit existing violation
- [ ] Data refreshes after submit
- [ ] Error messages show correctly

## API Endpoints

**POST /api/violations-log**
```json
{
  "student_id": "uuid",
  "violation_type_id": "uuid",
  "reporting_teacher_id": "uuid",
  "notes": "string"
}
```

**PUT /api/violations-log/{id}**
```json
{
  "student_id": "uuid",
  "violation_type_id": "uuid",
  "reporting_teacher_id": "uuid",
  "notes": "string"
}
```

## Error Handling

**Validation Errors:**
- Student ID must be valid UUID
- Violation Type ID must be valid UUID
- Teacher ID must be valid UUID
- Notes must be at least 10 characters

**API Errors:**
- Shows toast with error message
- Form stays open for correction
- Loading state handled properly

## Summary

**Status:** ✅ Complete Refactor
**Lines:** 435 → 320 (26% reduction)
**Complexity:** Significantly reduced
**API Compatibility:** ✅ Matches new API structure
**Backward Compatible:** ❌ No (breaking change)

**Impact:**
- ✅ Simpler code
- ✅ More reliable
- ✅ Better UX
- ✅ Easier to maintain

---

**Updated:** 2025-11-29
**Status:** Complete
